<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pay with RC</title>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Urbanist', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .checkout-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 380px; text-align: center; }
        
        .logo { font-size: 24px; font-weight: 800; color: #4f46e5; margin-bottom: 20px; }
        .amount-box { background: #4f46e5; color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .amount-val { font-size: 32px; font-weight: bold; }
        
        input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: #4f46e5; }
        
        .pay-btn { width: 100%; padding: 15px; background: #0f172a; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .pay-btn:hover { background: #1e293b; }

        .loader { display: none; margin-top: 10px; color: #666; font-size: 14px; }
    </style>
</head>
<body>

    <div class="checkout-card" id="pay-screen">
        <div class="logo">RC PAY</div>
        
        <p style="color:#666; font-size:14px;">Merchant Payment</p>
        <div class="amount-box">
            <div style="font-size:12px; opacity:0.8;">TOTAL PAYABLE</div>
            <div class="amount-val"><span id="amt">0</span> RC</div>
        </div>

        <input type="email" id="u-email" placeholder="Your Wallet Email">
        <input type="password" id="u-pass" placeholder="Password">
        <input type="password" id="u-pin" placeholder="4-Digit PIN" maxlength="4" style="text-align:center; letter-spacing:5px;">
        
        <button class="pay-btn" onclick="processPayment()">CONFIRM PAYMENT</button>
        <div class="loader" id="msg">Processing...</div>
    </div>

    <div class="checkout-card" id="success-screen" style="display: none;">
        <div style="font-size: 50px; color: #10b981;">✔</div>
        <h2>Payment Successful!</h2>
        <p>Transaction Completed.</p>
        <button class="pay-btn" onclick="window.close()">Close Window</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, addDoc, collection } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBz643NOFN6bZsLC8Z5SbLE3LAEvbz5Q9k",
            authDomain: "rc-wallet-6a410.firebaseapp.com",
            projectId: "rc-wallet-6a410",
            storageBucket: "rc-wallet-6a410.firebasestorage.app",
            messagingSenderId: "650409149510",
            appId: "1:650409149510:web:4284280db56b18c18d7647"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // URL থেকে Merchant ID এবং Amount নেওয়া
        const params = new URLSearchParams(window.location.search);
        const merchantId = params.get('merchant');
        const amount = parseFloat(params.get('amount'));

        if(amount) document.getElementById('amt').innerText = amount;
        else alert("Invalid Payment Link");

        window.processPayment = async () => {
            const email = document.getElementById('u-email').value;
            const pass = document.getElementById('u-pass').value;
            const pin = document.getElementById('u-pin').value;
            const msg = document.getElementById('msg');

            if(!email || !pass || !pin || !merchantId || !amount) return alert("Fill all fields");

            msg.style.display = 'block';
            msg.innerText = "Authenticating...";

            try {
                // 1. User Login check
                const cred = await signInWithEmailAndPassword(auth, email, pass);
                const user = cred.user;

                // 2. Verify User Data & Balance
                msg.innerText = "Verifying Balance...";
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();

                if(userData.pin !== pin) throw new Error("Wrong PIN");
                if(userData.balance < amount) throw new Error("Insufficient Balance");

                // 3. Process Transaction
                msg.innerText = "Transferring RC...";
                const merchantRef = doc(db, "merchants", merchantId);

                // Deduct from User
                await updateDoc(userRef, { balance: increment(-amount) });
                // Add to Merchant
                await updateDoc(merchantRef, { balance: increment(amount) });

                // 4. Record Transaction
                await addDoc(collection(db, "merchant_transactions"), {
                    merchantId: merchantId,
                    userId: user.uid,
                    amount: amount,
                    date: new Date().toISOString()
                });

                document.getElementById('pay-screen').style.display = 'none';
                document.getElementById('success-screen').style.display = 'block';

            } catch (error) {
                alert("Payment Failed: " + error.message);
                msg.style.display = 'none';
            }
        }
    </script>
</body>
</html>
